name: AVD_VNC

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    # Uses the standard GitHub-Hosted Linux (Ubuntu) Runner
    runs-on: ubuntu-latest
    timeout-minutes: 360 

    steps:
      - name: Setup Java and Android SDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Create and Run Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: default
          arch: x86_64
          profile: Nexus 6
          # The corrected script input is here:
          script: |
            # 1. Wait for the emulator to be fully booted (Essential)
            echo "Waiting for Android Emulator to boot..."
            /usr/local/lib/android/sdk/platform-tools/adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do echo "Waiting for boot..."; sleep 5; done;'

            echo "Emulator is booted."
            
            # 2. Print VNC Connection Information (VNC is exposed by the action itself)
            echo "--- VNC Connection Setup ---"
            echo "VNC should be accessible on port 5900 of the hosted runner."
            echo "------------------------------"

            # 3. Keep the job running indefinitely (Crucial for VNC session longevity)
            echo "Entering maintain connection loop..."
            while true; do
              echo "[$(date)] AVD Active - Use Ctrl+C in workflow to terminate."
              sleep 300
            done

      - name: Install Tailscale on Runner Host
        run: |
          # Install Tailscale on the Ubuntu host machine
          curl -fsSL https://pkgs.tailscale.com/install.sh | sh
          
      - name: Establish Tailscale Connection on Runner Host
        env:
          TS_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          # Bring up Tailscale on the host with the provided auth key
          sudo tailscale up --authkey=$TS_AUTH_KEY --hostname=gh-android-runner-$GITHUB_RUN_ID
          
          # Wait for Tailscale to assign an IP
          TS_IP=$(sudo tailscale ip -4)
          while [ -z "$TS_IP" ]; do sleep 5; TS_IP=$(sudo tailscale ip -4); done
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          
      - name: Maintain Connection (Final Output)
        run: |
          echo -e "\n=== VNC ACCESS ==="
          echo "Address: $TAILSCALE_IP:5900 (Use VNC Client)"
          echo "==================\n"
          
          # Keep the job from completing immediately (The previous step's loop keeps it alive,
          # but this final step ensures output of credentials is easy to see)
          echo "Checking connection status..."
          sleep 10
